name: Deploy to NCP

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ${{ secrets.NCP_REGISTRY }}
  IMAGE_NAME: studymate-app

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle
      run: ./gradlew build -x test

    - name: Build Docker image
      run: |
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

    - name: Login to NCP Container Registry
      run: |
        echo ${{ secrets.NCP_SECRET_KEY }} | docker login ${{ env.REGISTRY }} -u ${{ secrets.NCP_ACCESS_KEY }} --password-stdin

    - name: Push Docker image
      run: |
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

    - name: Deploy to NCP Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.NCP_SERVER_HOST }}
        username: ${{ secrets.NCP_SERVER_USER }}
        key: ${{ secrets.NCP_SERVER_SSH_KEY }}
        port: 22
        script: |
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export DOCKER_REGISTRY=${{ env.REGISTRY }}
          export APP_IMAGE_VERSION=${{ github.sha }}
          export DB_HOST=${{ secrets.DB_HOST }}
          export DB_PORT=${{ secrets.DB_PORT }}
          export DB_NAME=${{ secrets.DB_NAME }}
          export DB_USER=${{ secrets.DB_USER }}
          export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          export REDIS_HOST=${{ secrets.REDIS_HOST }}
          export REDIS_PORT=${{ secrets.REDIS_PORT }}
          export REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          export JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          export NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
          export NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
          
          # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /app/studymate
          
          # ì»¨í…Œì´ë„ˆ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
          echo ${{ secrets.NCP_SECRET_KEY }} | sudo docker login ${{ env.REGISTRY }} -u ${{ secrets.NCP_ACCESS_KEY }} --password-stdin
          
          # ìµœì‹  ì´ë¯¸ì§€ Pull
          sudo docker-compose -f docker-compose.prod.yml pull
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘
          sudo docker-compose -f docker-compose.prod.yml down
          sudo docker-compose -f docker-compose.prod.yml up -d
          
          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
          sudo docker system prune -f
          
          # ë°°í¬ ì™„ë£Œ í™•ì¸
          sleep 30
          curl -f http://localhost:8080/actuator/health || exit 1
          
          echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"

    - name: Notify deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "ğŸ‰ ë°°í¬ ì„±ê³µ: ${{ github.sha }}"
        else
          echo "âŒ ë°°í¬ ì‹¤íŒ¨: ${{ github.sha }}"
        fi